pipeline {
    agent { label 'aws-ready' }

    tools {
        go '1.18.1' 
    }

    stages {
        stage('Run TFlint') {
            steps {
                dir("terratest/terraform/") {
                    sh 'tflint --init'
                    sh 'tflint'
                }
            }
            post {
                success {
                    echo 'tflint passed'
                }
            }
        }
        stage('Run Terratest') {
            steps {
                dir("terratest/test/") {
                    sh 'go mod tidy'
                    sh 'go test network_test.go -v -timeout 30m'
                }
            }
            post{
                failure {
                    sh 'echo test failed'
                }
            }
        }
        stage('Terraform init') {
            steps {
                dir("terratest/terraform/") {
                    script {
                        sh 'terraform init'
                    }
                }
            }
        }
        stage('Terraform plan') {
            steps {
                dir("terratest/terraform/") {
                    script {
                        sh 'terraform plan'
                    }
                }
            }
        }
    }
}